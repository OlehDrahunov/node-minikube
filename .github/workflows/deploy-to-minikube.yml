name: Deploy to Minikube

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    env:
      IMAGE_TAG: git-${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      
      - name: Cache Minikube kicbase image
        uses: actions/cache@v4
        with:
          path: /tmp/minikube-cache
          key: minikube-kicbase-v1.33.1-${{ hashFiles('**/k8s-minikube/kicbase/**') }}
          restore-keys: |
            minikube-kicbase-v1.33.1-

     
      - name: Start Minikube
        uses: ifeelgoods/minikube-action@v1.3.0
        with:
          kubernetes-version: v1.30.0
          driver: docker
          container-runtime: docker
          cache-images: true         
          cache-path: /tmp/minikube-cache

      
      - name: Minikube status
        run: |
          minikube status
          kubectl cluster-info

     
      - name: Build Docker image
        run: |
          docker build -t devopshint/node-app:${{ env.IMAGE_TAG }} .

      - name: Load image into Minikube
        run: |
          minikube image load devopshint/node-app:${{ env.IMAGE_TAG }}

      - name: Render & deploy manifest
        run: |
          sed "s|\${IMAGE_TAG}|${{ env.IMAGE_TAG }}|g" k8s-node-app.yaml > rendered.yaml
          kubectl apply -f rendered.yaml
          kubectl rollout status deployment/nodejs-app --timeout=180s

      - name: Wait for ready pods
        run: kubectl wait --for=condition=ready pod -l app=nodejs-app --timeout=180s

      - name: Get service URL
        id: url
        run: |
          URL=$(minikube service nodejs-app --url=true | head -1)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          for i in {1..20}; do
            if curl -fsL "${{ steps.url.outputs.url }}" | grep -q "Hello World"; then
              echo "App is working!"
              exit 0
            fi
            sleep 3
          done
          echo "App failed to start"
          exit 1

      - name: Debug on failure
        if: failure()
        run: |
          minikube status
          kubectl get all -l app=nodejs-app
          kubectl describe pod -l app=nodejs-app
          kubectl logs -l app=nodejs-app --tail=100
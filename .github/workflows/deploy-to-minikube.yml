name: Deploy to Minikube

on:
  push:
    branches: [ master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Minikube
        uses: medyagh/setup-minikube@v0.0.18
        with:
          minikube-version: 1.33.1
          kubernetes-version: v1.30.0

      - name: Build and load image
        run: |
          export IMAGE_TAG="git-${{ github.sha }}"
          docker build -t devopshint/node-app:${IMAGE_TAG} .
          minikube image load devopshint/node-app:${IMAGE_TAG}

      - name: Deploy to cluster
        run: |
          export IMAGE_TAG="git-${{ github.sha }}"
          envsubst < k8s-node-app.yaml | kubectl apply -f -
          kubectl rollout status deployment/nodejs-app --timeout=120s

      - name: Verify application
        run: |
          kubectl wait --for=condition=ready pod -l app=nodejs-app --timeout=120s
          URL=$(minikube service nodejs-app --url | head -1)
          echo "Testing application at: $URL"
          
          for i in {1..30}; do
            if curl -s --fail "$URL" | grep -q "Hello World"; then
              echo "✓ Application is up and running!"
              curl -s "$URL"
              exit 0
            fi
            echo "⏳ Waiting for app... ($i/30)"
            sleep 5
          done
          
          echo "✗ Application did not respond correctly"
          kubectl get pods -l app=nodejs-app
          kubectl logs -l app=nodejs-app --tail=50
          exit 1

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments
          echo "=== Pod Status ==="
          kubectl get pods -l app=nodejs-app
          echo "=== Pod Logs ==="
          kubectl logs -l app=nodejs-app --tail=100 || true
          echo "=== Events ==="
          kubectl get events --sort-by='.lastTimestamp' | tail -20